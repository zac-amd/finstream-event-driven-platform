server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Use Docker DNS resolver with caching
    resolver 127.0.0.11 valid=30s ipv6=off;
    resolver_timeout 5s;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # ========================================================================
    # API Documentation - Swagger UI for all services
    # ========================================================================
    
    # API Gateway Swagger docs
    location /api-docs/ {
        set $api_upstream http://api-gateway:8080;
        proxy_pass $api_upstream/docs;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api-docs {
        set $api_upstream http://api-gateway:8080;
        proxy_pass $api_upstream/docs;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api-redoc {
        set $api_upstream http://api-gateway:8080;
        proxy_pass $api_upstream/redoc;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /openapi.json {
        set $api_upstream http://api-gateway:8080;
        proxy_pass $api_upstream/openapi.json;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Portfolio Service Swagger docs
    location /portfolio-docs/ {
        set $portfolio_upstream http://portfolio-service:8003;
        proxy_pass $portfolio_upstream/docs;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /portfolio-docs {
        set $portfolio_upstream http://portfolio-service:8003;
        proxy_pass $portfolio_upstream/docs;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Market Data Service Swagger docs
    location /market-docs/ {
        set $market_upstream http://market-data-service:8002;
        proxy_pass $market_upstream/docs;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /market-docs {
        set $market_upstream http://market-data-service:8002;
        proxy_pass $market_upstream/docs;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Portfolio Service API - auth, portfolios, trading
    location /api/v1/auth/ {
        set $portfolio_upstream http://portfolio-service:8003;
        proxy_pass $portfolio_upstream/api/v1/auth/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Authorization $http_authorization;
        proxy_connect_timeout 5s;
        proxy_read_timeout 30s;
    }

    location /api/v1/portfolios {
        set $portfolio_upstream http://portfolio-service:8003;
        proxy_pass $portfolio_upstream/api/v1/portfolios;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Authorization $http_authorization;
        proxy_connect_timeout 5s;
        proxy_read_timeout 30s;
    }

    location /api/v1/leaderboard {
        set $portfolio_upstream http://portfolio-service:8003;
        proxy_pass $portfolio_upstream/api/v1/leaderboard;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_connect_timeout 5s;
        proxy_read_timeout 30s;
    }

    # Market Summary API - api-gateway
    location /api/v1/market-summary {
        set $api_upstream http://api-gateway:8080;
        proxy_pass $api_upstream/api/v1/market-summary;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_connect_timeout 5s;
        proxy_read_timeout 30s;
    }

    # Yahoo Finance API - market-data-service
    location ~ ^/api/v1/yahoo/(.*)$ {
        set $market_upstream http://market-data-service:8002;
        proxy_pass $market_upstream/api/v1/yahoo/$1$is_args$args;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_connect_timeout 5s;
        proxy_read_timeout 30s;
    }

    # Candles API - api-gateway
    location ~ ^/api/v1/candles/(.*)$ {
        set $api_upstream http://api-gateway:8080;
        proxy_pass $api_upstream/api/v1/candles/$1$is_args$args;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_connect_timeout 5s;
        proxy_read_timeout 30s;
    }

    # Trades API - api-gateway
    location ~ ^/api/v1/trades/(.*)$ {
        set $api_upstream http://api-gateway:8080;
        proxy_pass $api_upstream/api/v1/trades/$1$is_args$args;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_connect_timeout 5s;
        proxy_read_timeout 30s;
    }

    # Main API Gateway
    location /api/ {
        set $api_upstream http://api-gateway:8080;
        proxy_pass $api_upstream/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 5s;
        proxy_read_timeout 30s;
    }

    location /ws/ {
        set $api_upstream http://api-gateway:8080;
        proxy_pass $api_upstream/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_connect_timeout 5s;
        proxy_read_timeout 60s;
    }
}
